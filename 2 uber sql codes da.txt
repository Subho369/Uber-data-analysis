


--Uber Data analysis

--Q1 Which hour of the day receives the highest number of trip requests?

select top 1 DATEPART(hour, Request_timestamp ) as hours,count(*) as request_orders
from uber_data
group by DATEPART(hour, Request_timestamp )
order by request_orders desc;


--Q2 What percentage of total ride requests remain unfulfilled 
--(Cancelled + No Cars Available) per day?

with cte1 
as(
select FORMAT(Request_date, 'ddd') as days, count(*) as total_trip_request ,
sum(case when Status in ('No Cars Available','cancelled') then 1 else 0 end) as unfulfilled_trip_cnt
from uber_data 
group by FORMAT(Request_date, 'ddd')
)
select *, round(100.0*unfulfilled_trip_cnt/total_trip_request,2) as unfulfilled_trip_pct
from cte1;


--Q3 Which driver completed the most number of trips in a day find top 3 drivers? 
--What was their average trip duration?


select top 3  Driver_id,Request_date,
COUNT(*) as complted_trip_cnt, avg(Travel_duration_min) as avg_trip_duration
from uber_data
where Status = 'Trip Completed'
group by Driver_id,Request_date
order by complted_trip_cnt desc
;



--q4 Which pickup point has the highest cancellation rate?


with cte1 as
(
select Pickup_point, count(*) as total_trip_request,
sum(case when Status = 'cancelled' then 1 end) as trip_cancellation_cnt
from uber_data
group by Pickup_point
)
select *, round(100.*trip_cancellation_cnt/total_trip_request,2) as cancellation_rate
from cte1 ;

-- or

with cte1 as
(
select Pickup_point,count(*) as trip_cancelled_cnt
from uber_data
where Status = 'cancelled'
group by Pickup_point
)
select *, sum(trip_cancelled_cnt)over() as all_trip_cancellation,
(100.0*trip_cancelled_cnt/sum(trip_cancelled_cnt)over() ) as trip_cancellation_pct
from cte1 ;



--Q5 Are there drivers who cancelled more than 3 trips in a single day?

select Request_date,Driver_id, count(*) as per_day_trip_cancelled_cnt 
from uber_data
where Status = 'cancelled'
group by Request_date,Driver_id
having count(*)>3
;


--Q6 Which day of the week has the most completed trips?

select top 1 FORMAT(Request_date,'ddd')as days,Request_date, 
count(*) as complted_trip_cnt 
from uber_data
where Status = 'Trip Completed'
group by Request_date, FORMAT(Request_date,'ddd')
order by complted_trip_cnt desc;



--Q7What is the average trip duration per driver? 
--Identify drivers with very high or very low average durations.


select * from
(
select Driver_id, avg(Travel_duration_min) as avg_travel_duration_min,
ROW_NUMBER()over(order by avg(Travel_duration_min) desc) as rnk_avg_travel_duration
from uber_data
group by Driver_id
)A
where rnk_avg_travel_duration = 1

Union all

select * from
(
select Driver_id, avg(Travel_duration_min) as avg_travel_duration_min,
ROW_NUMBER()over(order by avg(Travel_duration_min) Asc) as rnk_avg_travel_duration
from uber_data
where Driver_id <> ''
group by Driver_id
)B
where rnk_avg_travel_duration = 1 ;


--Q8 What is the 3-day moving average of total completed trips? 
--How does it compare to the actual on the 4th day?

with cte1
as(
select Request_date, count(*) as total_completed_trips,
ROW_NUMBER()over(order by Request_date) day_no
from uber_data
where status = 'Trip Completed'
group by Request_date
)
select * ,
avg(total_completed_trips)
over(order by Request_date rows between 2 preceding and  current row) as '3_day_moving_avg_trip'
from cte1
where day_no = 4;


--Q9 Which hours show the largest supply-demand gap? (Where supply < demand)

with cte1
as(
select DATEPART(HOUR,Request_timestamp) as hours,
count(*) as total_trip_request,
sum(case when status = 'Trip Completed' then 1 end) as completed_trip_cnt
from uber_data
group by DATEPART(HOUR,Request_timestamp)
)
select top 1 *, (total_trip_request-completed_trip_cnt) as demand_supply_gap 
from cte1
order by demand_supply_gap desc;



--Q10 How many potential customers were lost due to cancellations and unavailability during peak hours?
-- identify the top 3 pick hour based on the trip request and find how many customers we lost?


with cte1
as(
select DATEPART(HOUR,Request_timestamp) as hours,
count(*) as total_trip_request,
sum(case when status = 'Trip Completed' then 1 end) as completed_trip_cnt
from uber_data
group by DATEPART(HOUR,Request_timestamp)
)
select top 3 *, (total_trip_request-completed_trip_cnt) as demand_supply_gap 
from cte1
order by demand_supply_gap desc;

